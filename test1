import sqlite3
import sys
from tqdm import tqdm

# Connect to the original SQLite database
db_name = sys.argv[1]
conn = sqlite3.connect(db_name)

# Update the 'grouped_trades' table
query_update = f"""
    UPDATE grouped_trades AS g1
    SET ORFInd = CASE
        WHEN g2.Pty_R = '18' AND g2.ORFInd = 'Y' THEN 'Y'
        ELSE ORFInd
        END
    FROM grouped_trades AS g2
    WHERE g1.Rpt_ID = g2.Rpt_ID
      AND g2.Pty_R = '1';
"""

# Count the number of rows to update
count_query = f"""
    SELECT COUNT(*) FROM grouped_trades AS g1
    WHERE EXISTS (
        SELECT 1
        FROM grouped_trades AS g2
        WHERE g1.Rpt_ID = g2.Rpt_ID
          AND g2.Pty_R = '1'
          AND g2.ORFInd = 'Y'
    ) AND g1.Pty_R = '18';
"""

# Get the count of rows to update
cursor = conn.execute(count_query)
total_rows_to_update = cursor.fetchone()[0]

# Create a progress bar
with tqdm(total=total_rows_to_update, desc='Updating rows') as pbar:
    conn.execute(query_update)
    conn.commit()
    pbar.update(total_rows_to_update)

# Close the connection to the database
conn.close()

print("Data has been successfully updated.")
