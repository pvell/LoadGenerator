#!/bin/bash

current_date=$(date +"%Y-%m-%d")
date=$(date -d "$current_date - 1 day" +"%Y-%m-%d")

mm_dd=$(date -d "$date" +"%m-%d")

# Create the output directory if it doesn't exist
output_dir="/data/orsa-intermediate"

# Define the directory where the compressed files are located
base_dir="/mnt/occ/downloads/prod"

# Construct the compressed file name using the provided date
compressed_file_to_watch="memx_orsa_trades_$date.xml.Z"

# Define the monitor folder
monitor_folder="$base_dir"

# Check if the compressed file exists, wait up to 10 times
retries=10
while [ ! -e "$monitor_folder/$compressed_file_to_watch" ] && [ $retries -gt 0 ]; do
    echo "$compressed_file_to_watch not found in $monitor_folder. Waiting..."
    sleep 10  # Adjust the interval as needed
    ((retries--))
done

if [ $retries -eq 0 ]; then
    echo "Compressed file not found after 10 retries. Exiting."
    exit 1
fi

echo "Found $compressed_file_to_watch"

# Check if the XML file is complete by examining the last two lines
last_two_lines=$(zcat "$monitor_folder/$compressed_file_to_watch" | tail -n 2)

if [[ $last_two_lines != *"</FIXML>"* ]]; then
    echo "XML file is not complete. Missing </FIXML> tag."
    exit 1
fi

# Uncompress the file and wait for it to complete
echo "Uncompressing $compressed_file_to_watch..."
zcat "$monitor_folder/$compressed_file_to_watch" > "$monitor_folder/memx_orsa_trades_$date.xml"

# Define a function to execute trades and exchange recon
execute_trades_and_recon() {
    # Add the content of run_trades.sh here
    # ... (rest of the script remains unchanged)
}

# Execute the combined trades and exchange recon function
execute_trades_and_recon

echo "Scripts executed successfully."

mv *"$mm_dd.csv" "$output_dir/"
