import struct

def send_and_receive(self, message_type, message):
    # Send the message over the TCP connection
    send_message(self.client_socket, message)

    while True:
        # Receive data from the socket
        try:
            received_data = self.client_socket.recv(4096)
        except ConnectionResetError:
            print("Connection reset by peer")
            break

        if not received_data:
            # If no more data is received, exit the loop
            break

        # Initialize a buffer to store received data
        receive_buffer = received_data

        while len(receive_buffer) > 3:
            # Read the header to determine message length (3 bytes)
            header_bytes = receive_buffer[:3]
            
            # Unpack the header
            message_length = struct.unpack('!H', header_bytes[1:3])[0]

            # Check if the complete message is in the buffer
            if len(receive_buffer) < 3 + message_length:
                break

            # Extract the complete message
            complete_message = receive_buffer[3:3 + message_length]
            print('Complete message:', complete_message)

            # Process the complete message
            self.handle_sbe_message(complete_message, message_type)

            # Update the receive buffer for the next iteration
            receive_buffer = receive_buffer[3 + message_length:]












short_two_side_bulk_quote:
b"h\x00x\x00'\x02\t\x01\x06\x02\x17\x99\xa9\xd4y\xb5\xa2\x00WMHX8FK6N6UFGVAAM47D0\x00\x01\x06\x00\x01\x01\x00\x01\x00\x01\x12\x02MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00D\x01MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00DB\x11\x02\x01N1tX6ooL\x00d\x002\x00\xc8\x00Q\x02N1tX6ooL\x00\x96\x00P\x00\xfa\x00U"
receive buffer:  b'\x00\t\x0b\x00c\x006\x0c\t\x01\x06\x01WMHX8FK6N6UFGVAAM47DNFLX  0\x00\x01\x06\x17\x99\xa9\xd4y\xc5\x86\x17\x17\x99\xa9\xd4y\xc4!\x96\x00\x01\x01\x00\x01\x00\x01\x04\x12\x02MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00D\x01MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00DB\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa0WMHX8FK6N6UFGVAAM47D\x01\x03\x00\x02\x00\x00\x00\x05\x7f0N1tX6ooL1\x00\x00\x00d\x00\x00\x00\x00\x02\xfa\xf0\x80\x00\x00\x00d\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe7$\xf6\x17\x99\xa9\xd4y\xccB\xe6\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa1WMHX8FK6N6UFGVAAM47D\x01\x03\x00\x02\x00\x00\x00\x05\x800N1tX6ooL2\x00\x00\x00\xc8\x00\x00\x00\x00\x04\xd3\xf6@\x00\x00\x00\xc8\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe7\x8f#\x17\x99\xa9\xd4y\xccF\x18\x0b\x00d\x00]\x11\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa0WMHX8FK6N6UFGVAAM47D\x02WMHX8FK6N6UFGVAAM47D\x03\x00\x02\x00\x00\x00\x05\x814\x01N1tX6ooL1\x00\x00\x00\x00\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8K\x89\x17\x99\xa9\xd4y\xccJ>\x01\x0b\x00d\x00]\x11\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa1WMHX8FK6N6UFGVAAM47D\x02WMHX8FK6N6UFGVAAM47D\x03\x00\x02\x00\x00\x00\x05\x824\x01N1tX6ooL2\x00\x00\x00\x00\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8\xaa\xee\x17\x99\xa9\xd4y\xccL\x06\x01\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa2WMHX8FK6N6UFGVAAM47D\x02\x03\x00\x02\x00\x00\x00\x05\x830N1tX6ooL1\x00\x00\x00\x96\x00\x00\x00\x00\x04\xc4\xb4\x00\x00\x00\x00\x96\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8\xfcI\x17\x99\xa9\xd4y\xccM\xa4\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa3WMHX8FK6N6UFGVAAM47D\x02\x03\x00\x02\x00\x00\x00\x05\x840N1tX6ooL2\x00\x00\x00\xfa\x00\x00\x00\x00\x05\x10\xff@\x00\x00\x00\xfa\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe9\xa6\xbe\x17\x99\xa9\xd4y\xccP\x80\x00\x00\x00'
len(receive_buffer): 685
message length: 2315
complete message:  b'\x00\t\x0b\x00c\x006\x0c\t\x01\x06\x01WMHX8FK6N6UFGVAAM47DNFLX  0\x00\x01\x06\x17\x99\xa9\xd4y\xc5\x86\x17\x17\x99\xa9\xd4y\xc4!\x96\x00\x01\x01\x00\x01\x00\x01\x04\x12\x02MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00D\x01MT05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00DB\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa0WMHX8FK6N6UFGVAAM47D\x01\x03\x00\x02\x00\x00\x00\x05\x7f0N1tX6ooL1\x00\x00\x00d\x00\x00\x00\x00\x02\xfa\xf0\x80\x00\x00\x00d\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe7$\xf6\x17\x99\xa9\xd4y\xccB\xe6\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa1WMHX8FK6N6UFGVAAM47D\x01\x03\x00\x02\x00\x00\x00\x05\x800N1tX6ooL2\x00\x00\x00\xc8\x00\x00\x00\x00\x04\xd3\xf6@\x00\x00\x00\xc8\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe7\x8f#\x17\x99\xa9\xd4y\xccF\x18\x0b\x00d\x00]\x11\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa0WMHX8FK6N6UFGVAAM47D\x02WMHX8FK6N6UFGVAAM47D\x03\x00\x02\x00\x00\x00\x05\x814\x01N1tX6ooL1\x00\x00\x00\x00\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8K\x89\x17\x99\xa9\xd4y\xccJ>\x01\x0b\x00d\x00]\x11\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa1WMHX8FK6N6UFGVAAM47D\x02WMHX8FK6N6UFGVAAM47D\x03\x00\x02\x00\x00\x00\x05\x824\x01N1tX6ooL2\x00\x00\x00\x00\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8\xaa\xee\x17\x99\xa9\xd4y\xccL\x06\x01\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa2WMHX8FK6N6UFGVAAM47D\x02\x03\x00\x02\x00\x00\x00\x05\x830N1tX6ooL1\x00\x00\x00\x96\x00\x00\x00\x00\x04\xc4\xb4\x00\x00\x00\x00\x96\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe8\xfcI\x17\x99\xa9\xd4y\xccM\xa4\x0b\x00Z\x00S\r\t\x01\x06\x00\x03\x00\x02\x00\x00\x00\x01\xa3WMHX8FK6N6UFGVAAM47D\x02\x03\x00\x02\x00\x00\x00\x05\x840N1tX6ooL2\x00\x00\x00\xfa\x00\x00\x00\x00\x05\x10\xff@\x00\x00\x00\xfa\x00\x00\x00\x00\x17\x99\xa9\xd4y\xe9\xa6\xbe\x17\x99\xa9\xd4y\xccP\x80\x00\x00\x00'
