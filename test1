import sqlite3
import sys
from tqdm import tqdm
from datetime import datetime

# Connect to the original SQLite database
db_name = sys.argv[1]
conn = sqlite3.connect(db_name)

# Create a progress bar for overall progress
overall_pbar = tqdm(desc='Updating rows', dynamic_ncols=True)

batch_size = 1000  # Adjust as needed
updated_rows = True

while updated_rows:
    # Update the 'grouped_trades' table for the current batch
    query_update = f"""
        UPDATE grouped_trades AS g1
        SET ORFInd = 'Y', UpdateTimestamp = '{datetime.now()}'
        WHERE EXISTS (
            SELECT 1
            FROM grouped_trades AS g2
            WHERE g1.Rpt_ID = g2.Rpt_ID
              AND g2.Pty_R = '18'
              AND g2.ORFInd = 'Y'
        ) AND g1.Pty_R = '1'
        LIMIT {batch_size};
    """

    # Execute the batch update query
    conn.execute(query_update)
    conn.commit()

    # Check if any rows were updated in the current batch
    rows_updated = conn.total_changes

    # Update the progress bar for the current batch
    overall_pbar.update(1)
    # Flush the stdout buffer to ensure real-time progress updates
    sys.stdout.flush()

    # If no rows were updated in the current batch, exit the loop
    if rows_updated == 0:
        updated_rows = False

# Close the connection to the database
conn.close()

# Close the progress bar
overall_pbar.close()

print("Data has been successfully updated.")
