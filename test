import sqlite3

# Connect to the original SQLite database
conn = sqlite3.connect('trades.db')

# Drop the 'grouped_trades' table if it exists
conn.execute('DROP TABLE IF EXISTS grouped_trades')

# Create a new table to store the query results
conn.execute('''CREATE TABLE grouped_trades AS
                 SELECT 
                     Side,
                     Rpt_ID,
                     Quantity,
                     MIN(CASE WHEN Ultimate_Clearing_Firm IS NOT NULL AND Ultimate_Clearing_Firm != '' THEN Ultimate_Clearing_Firm END) AS Ultimate_Clearing_Firm,
                     MIN(CASE WHEN Entering_Firm_Col1 IS NOT NULL AND Entering_Firm_Col1 != '' THEN Entering_Firm_Col1 END) AS Entering_Firm_Col1,
                     EXCH,
                     TRANS_TYPE
                 FROM trades
                 WHERE Sub_ID IS NOT NULL AND Sub_ID != ''
                 GROUP BY Side, Rpt_ID, Quantity, EXCH, TRANS_TYPE''')

# Commit the changes and close the connection to the original database
conn.commit()
conn.close()

print("Data has been successfully inserted into the 'grouped_trades' table.")
