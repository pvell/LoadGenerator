import pandas as pd
import sqlite3

# Connect to the SQLite database
conn = sqlite3.connect('trades.db')

# Query the data from the database with grouping and aggregation
query = """
    SELECT 
        Side,
        Sub_ID,
        Rpt_ID,
        FIRST_VALUE(Ultimate_Clearing_Firm) AS Ultimate_Clearing_Firm,
        FIRST_VALUE(Entering_Firm_Col1) AS Entering_Firm_Col1,
        FIRST_VALUE(Entering_Firm_Col2) AS Entering_Firm_Col2
    FROM trades
    GROUP BY Side, Sub_ID, Rpt_ID
"""

# Fetch the data and create the DataFrame
grouped_trade_data_frame = pd.read_sql_query(query, conn)

# Close the database connection
conn.close()

# Dump the DataFrame into an Excel file
output_file = 'grouped_trades.xlsx'
grouped_trade_data_frame.to_excel(output_file, index=False)

print(f"Data has been successfully dumped to '{output_file}'.")
