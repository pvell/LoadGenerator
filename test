sqlite> select * from grouped_trades limit 10;
Side  Sub_ID  Rpt_ID     Pty_R  Ultimate_Clearing_Firm  EXCH  TRANS_TYPE  ORFInd  Quantity
----  ------  ---------  -----  ----------------------  ----  ----------  ------  --------
1     C       241802106  1      00015                         0                   3       
1             241802106  21                                   0                   3       
2     C       241802106  18     00075                         0                   3       
2             241802106  21                                   0                   3       
1     C       241802107  1      00015                         0                   1       
1             241802107  21                                   0                   1       
2     C       241802107  18     00075                         0                   1       
2             241802107  21                                   0                   1       
1     C       241802108  1      00062                         0                   1       
1             241802108  21                                   0                   1       
sqlite> 




import sqlite3
import sys

# Connect to the original SQLite database
db_name = sys.argv[1]
conn = sqlite3.connect(db_name)

# Drop the 'grouped_trades' table if it exists
conn.execute('DROP TABLE IF EXISTS grouped_trades')

# Create a new table for the current exchange to store the query results
conn.execute(f'''CREATE TABLE IF NOT EXISTS grouped_trades (
                    Side TEXT,
                    Sub_ID TEXT,
                    Rpt_ID TEXT,
                    Pty_R TEXT,
                    Ultimate_Clearing_Firm TEXT,
                    EXCH TEXT,
                    TRANS_TYPE TEXT,
                    ORFInd TEXT,
                    Quantity INTEGER  -- Add the Quantity column
                    )''')

# Query the data from the original table for the current exchange with grouping
query = f"""
    INSERT INTO grouped_trades (Side, Sub_ID, Rpt_ID, Pty_R, Ultimate_Clearing_Firm, EXCH, TRANS_TYPE, ORFInd, Quantity)
    SELECT
        t.Side,
        MAX(CASE WHEN t.Sub_ID != '' AND t.Sub_ID IS NOT NULL THEN t.Sub_ID END) AS Sub_ID,
        t.Rpt_ID,
        t.Pty_R,
        MAX(CASE WHEN t.Ultimate_Clearing_Firm != '' AND t.Ultimate_Clearing_Firm IS NOT NULL THEN t.Ultimate_Clearing_Firm END) AS Ultimate_Clearing_Firm,
        t.EXCH,
        t.TRANS_TYPE,
        t.ORFInd,
        t.Quantity
    FROM trades t
    WHERE t.Pty_R != '21'  -- Exclude rows where Pty_R is equal to 21
    GROUP BY t.Rpt_ID, t.Side, t.Quantity, t.TRANS_TYPE, t.ORFInd, t.Pty_R
"""

# Execute the query to insert the data into the new table for the current exchange
conn.execute(query)

# Commit the changes and close the connection to the original database
conn.commit()
conn.close()

print("Data with Pty_R=21 removed and successfully inserted into the grouped_trades table.")

