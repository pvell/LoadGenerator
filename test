import pandas as pd
import sqlite3

# Connect to the SQLite database
conn = sqlite3.connect('trades.db')

# Query the data from the grouped_trades_new table
query = "SELECT * FROM grouped_trades_new"

# Fetch the data into a pandas DataFrame
grouped_trade_data_frame = pd.read_sql_query(query, conn)

# Close the database connection
conn.close()

# Dump the DataFrame into an Excel file
output_file = 'grouped_trades_new.xlsx'
grouped_trade_data_frame.to_excel(output_file, index=False)

print(f"Data from grouped_trades_new has been successfully dumped to '{output_file}'.")





# Connect to the original SQLite database
conn = sqlite3.connect('trades.db')

# Create a new table to store the query results
conn.execute('''CREATE TABLE IF NOT EXISTS grouped_trades (
                    Side TEXT,
                    Rpt_ID TEXT,
                    Ultimate_Clearing_Firm TEXT,
                    Entering_Firm_Col1 TEXT,
                    EXCH TEXT,
                    TRANS_TYPE TEXT,
                    Quantity INTEGER  -- Add the Quantity column
                 )''')

# Query the data from the original table with grouping and aggregation, and insert it into the new table
query = """
    INSERT INTO grouped_trades (Side, Rpt_ID, Ultimate_Clearing_Firm, Entering_Firm_Col1, EXCH, TRANS_TYPE, Quantity)
    SELECT 
        Side,
        Rpt_ID,
        (SELECT Ultimate_Clearing_Firm FROM trades t1 WHERE t1.Side = t.Side AND t1.Rpt_ID = t.Rpt_ID AND t1.Ultimate_Clearing_Firm IS NOT NULL ORDER BY ROWID LIMIT 1) as Ultimate_Clearing_Firm,
        (SELECT Entering_Firm_Col1 FROM trades t2 WHERE t2.Side = t.Side AND t2.Rpt_ID = t.Rpt_ID AND t2.Entering_Firm_Col1 IS NOT NULL ORDER BY ROWID LIMIT 1) as Entering_Firm_Col1,
        EXCH,
        TRANS_TYPE,
        Quantity
    FROM trades t
    WHERE Sub_ID IS NOT NULL AND Sub_ID != ''
    GROUP BY Side, Rpt_ID, EXCH, TRANS_TYPE, Quantity
"""

# Execute the query to insert the data into the new table
conn.execute(query)

# Commit the changes and close the connection to the original database
conn.commit()
conn.close()

print("Data has been successfully inserted into the 'grouped_trades' table.")

