import deephaven



dh = deephaven.Client("your_deephaven_server_url", api_key="your_api_key")


# Define a function to find wash trades
def find_wash_trades():
    # Query orders table
    orders_query = "select * from orders"
    orders = dh.execute(orders_query)

    # Dictionary to store order details by order ID
    order_details = {}

    # Iterate through orders and check for potential wash trades
    for order in orders.iterrows():
        order_id = order['order_id']
        security = order['security']
        side = order['side']
        volume = order['volume']
        price = order['price']

        # Check if similar order details exist for the same security and opposite side
        potential_wash_trade = order_details.get((security, -side, volume, price))

        if potential_wash_trade:
            # Wash trade detected, insert alert
            alert_message = f"Wash Trade Detected: Order {order_id} is similar to Order {potential_wash_trade['order_id']}"
            dh.execute(f"insert into alerts(message) values ('{alert_message}')")

        # Store order details for future comparisons
        order_details[(security, side, volume, price)] = order

# Call the function to find wash trades and insert alerts
find_wash_trades()
