import quickfix as fix
import time
import datetime
import os
import socket

class MyApplication(fix.Application):
    def __init__(self):
        super().__init__()
        self.log_directory = "log"

    def onCreate(self, sessionID):
        print("Session created -", sessionID.toString())

    def fromApp(self, message, sessionID):
        # Log the received message to the specified file
        log_file_path = self.get_log_file()
        with open(log_file_path, "a") as log_file:
            log_file.write(f"Received FIX Message: {message.toString()}\n")

        # Handle incoming messages here

    def toApp(self, message, sessionID):
        msg_type = message.getHeader().getField(fix.MsgType()).getString()

        # Log the message to the specified file
        log_file_path = self.get_log_file()
        with open(log_file_path, "a") as log_file:
            log_file.write(f"Sent FIX Message: {message.toString()}\n")

        return super().toApp(message, sessionID)

    def fromAdmin(self, message, sessionID):
        pass

    def toAdmin(self, message, sessionID):
        msg_type = message.getHeader().getField(fix.MsgType()).getString()

        # Log the message to the specified file
        log_file_path = self.get_log_file()
        with open(log_file_path, "a") as log_file:
            log_file.write(f"Sent Admin FIX Message: {message.toString()}\n")

        if msg_type == fix.MsgType_Logon:
            message.getHeader().setField(1408, "1.3")
            message.getHeader().setField(43, "Y")
            print("Sent admin message:", message.toString())

        return True

    def onLogout(self, sessionID):
        print("Logout initiated -", sessionID.toString())

    def onLogon(self, sessionID):
        print("Logon Successful -", sessionID.toString())

    def get_log_file(self):
        log_directory = "log"
        os.makedirs(log_directory, exist_ok=True)
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H")
        log_file_name = f"log_file_{timestamp}.log"
        return os.path.join(self.log_directory, log_file_name)

    def run(self):
        interface = '10.2.44.2'
        port = 31991

        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        sock.bind((interface, port))
        print(f"Socket bound to {interface}:{port}")
        sock.listen(5)
        settings = fix.SessionSettings("acceptor.cfg")
        application = fix.SocketAcceptor(self, fix.FileStoreFactory(settings), settings)
        application.start()

        while True:
            time.sleep(1)

        application.stop()


app = MyApplication()

# Run the FIX application
app.run()
