import pandas as pd
import sqlite3

# Connect to the SQLite database
conn = sqlite3.connect('trades.db')

# Query the data from the grouped_trades_new table
query = "SELECT * FROM grouped_trades_new"

# Fetch the data into a pandas DataFrame
grouped_trade_data_frame = pd.read_sql_query(query, conn)

# Close the database connection
conn.close()

# Dump the DataFrame into an Excel file
output_file = 'grouped_trades_new.xlsx'
grouped_trade_data_frame.to_excel(output_file, index=False)

print(f"Data from grouped_trades_new has been successfully dumped to '{output_file}'.")






query = """
    INSERT INTO grouped_trades (Side, Rpt_ID, Ultimate_Clearing_Firm, Entering_Firm_Col1, EXCH, TRANS_TYPE, Quantity)
    SELECT 
        Side,
        Rpt_ID,
        MAX(Ultimate_Clearing_Firm) as Ultimate_Clearing_Firm,  -- Use MAX() to get the first non-null value
        MAX(Entering_Firm_Col1) as Entering_Firm_Col1,  -- Use MAX() to get the first non-null value
        EXCH,
        TRANS_TYPE,
        Quantity  -- Include the Quantity column as it is
    FROM trades
    WHERE Sub_ID IS NOT NULL AND Sub_ID != ''
    GROUP BY Side, Rpt_ID, EXCH, TRANS_TYPE, Quantity  -- Group by the required columns, including Quantity
"""
