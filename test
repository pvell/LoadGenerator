import sqlite3

# Connect to the original SQLite database
conn = sqlite3.connect('trades.db')

# Drop the 'grouped_trades' table if it exists
conn.execute('DROP TABLE IF EXISTS grouped_trades')

# Create a new table to store the query results
conn.execute('''CREATE TABLE grouped_trades AS
                 SELECT 
                     Side,
                     Rpt_ID,
                     Quantity,
                     Ultimate_Clearing_Firm,
                     Entering_Firm_Col1,
                     Sub_ID
                 FROM (
                     SELECT 
                         Side,
                         Rpt_ID,
                         Quantity,
                         Ultimate_Clearing_Firm,
                         Entering_Firm_Col1,
                         Sub_ID,
                         ROW_NUMBER() OVER (PARTITION BY Side, Rpt_ID ORDER BY Quantity) AS rn
                     FROM trades
                 )
                 WHERE rn = 1''')

# Commit the changes and close the connection to the original database
conn.commit()
conn.close()

print("Data has been successfully inserted into the 'grouped_trades' table.")
