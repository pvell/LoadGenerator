import pandas as pd
import sqlite3
from tqdm import tqdm  # Import tqdm for the progress bar

# Connect to the SQLite database
conn = sqlite3.connect('trades.db')

# Count the total number of rows to set the progress bar's maximum value
total_rows = pd.read_sql_query('SELECT COUNT(*) FROM trades WHERE Sub_ID IS NOT NULL AND Sub_ID != ""', conn)['COUNT(*)'].values[0]

# Initialize tqdm with the total number of rows
progress_bar = tqdm(total=total_rows, desc="Fetching Data")

# Query the data from the database with grouping and aggregation
query = """
    SELECT 
        Side,
        Sub_ID,
        Rpt_ID,
        Ultimate_Clearing_Firm,
        Entering_Firm_Col1,
        EXCH,
        TRANS_TYPE
    FROM (
        SELECT 
            Side,
            Sub_ID,
            Rpt_ID,
            Ultimate_Clearing_Firm,
            Entering_Firm_Col1,
            EXCH,
            TRANS_TYPE,
            ROW_NUMBER() OVER (PARTITION BY Side, Sub_ID, Rpt_ID ORDER BY
                               (CASE WHEN Ultimate_Clearing_Firm IS NOT NULL THEN 1 ELSE 0 END +
                                CASE WHEN Entering_Firm_Col1 IS NOT NULL THEN 1 ELSE 0 END) DESC) AS rn
        FROM trades
        WHERE Sub_ID IS NOT NULL AND Sub_ID != ''
    )
    WHERE rn = 1
"""

# Fetch the data in chunks and create the DataFrame
chunk_size = 1000  # Adjust the chunk size as per your requirement
grouped_trade_data_frames = []

for chunk in pd.read_sql_query(query, conn, chunksize=chunk_size):
    grouped_trade_data_frames.append(chunk)
    progress_bar.update(len(chunk))

# Concatenate all chunks into the final DataFrame
grouped_trade_data_frame = pd.concat(grouped_trade_data_frames)

# Close the database connection
conn.close()

# Dump the DataFrame into an Excel file
output_file = 'grouped_trades.xlsx'
grouped_trade_data_frame.to_excel(output_file, index=False)

print(f"Data has been successfully dumped to '{output_file}'.")



pvellanki@qa2434:~/orsa$ python3 dumptoxls.py 
Traceback (most recent call last):
  File "/home/pvellanki/orsa/dumptoxls.py", line 43, in <module>
    grouped_trade_data_frame.to_excel(output_file, index=False)
  File "/home/pvellanki/.local/lib/python3.10/site-packages/pandas/core/generic.py", line 2252, in to_excel
    formatter.write(
  File "/home/pvellanki/.local/lib/python3.10/site-packages/pandas/io/formats/excel.py", line 923, in write
    raise ValueError(
ValueError: This sheet is too large! Your sheet size is: 12680268, 7 Max sheet size is: 1048576, 16384
