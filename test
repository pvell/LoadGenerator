import sqlite3

# Connect to the original SQLite database
conn = sqlite3.connect('trades.db')

# Create a new table to store the query results
conn.execute('''CREATE TABLE IF NOT EXISTS grouped_trades (
                    Side TEXT,
                    Sub_ID TEXT,
                    Rpt_ID TEXT,
                    Ultimate_Clearing_Firm TEXT,
                    Entering_Firm_Col1 TEXT,
                    EXCH TEXT,
                    TRANS_TYPE TEXT
                 )''')

# Query the data from the original table with grouping and aggregation, and insert it into the new table
query = """
    INSERT INTO grouped_trades (Side, Sub_ID, Rpt_ID, Ultimate_Clearing_Firm, Entering_Firm_Col1, EXCH, TRANS_TYPE)
    SELECT 
        Side,
        Sub_ID,
        Rpt_ID,
        Ultimate_Clearing_Firm,
        Entering_Firm_Col1,
        EXCH,
        TRANS_TYPE
    FROM (
        SELECT 
            Side,
            Sub_ID,
            Rpt_ID,
            Ultimate_Clearing_Firm,
            Entering_Firm_Col1,
            EXCH,
            TRANS_TYPE,
            ROW_NUMBER() OVER (PARTITION BY Side, Sub_ID, Rpt_ID ORDER BY
                               (CASE WHEN Ultimate_Clearing_Firm IS NOT NULL THEN 1 ELSE 0 END +
                                CASE WHEN Entering_Firm_Col1 IS NOT NULL THEN 1 ELSE 0 END) DESC) AS rn
        FROM trades
        WHERE Sub_ID IS NOT NULL AND Sub_ID != ''
    )
    WHERE rn = 1
"""

# Execute the query to insert the data into the new table
conn.execute(query)

# Commit the changes and close the connection to the original database
conn.commit()
conn.close()

print("Data has been successfully inserted into the 'grouped_trades' table.")
